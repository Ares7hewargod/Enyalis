<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enyalis - Discord-like Chat</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Discord-like Layout */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .discord-container {
            display: flex;
            height: 100vh;
            background: #36393f;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        /* Ensure consistent centering for all circular avatar/button elements */
        .server-icon, .message-avatar, .dm-avatar, .user-avatar, .member-avatar, 
        .quick-add-btn, .user-result-avatar, .friend-card-avatar {
            text-align: center;
            vertical-align: middle;
        }

        /* Server List (Left Panel) */
        .server-list {
            width: 70px;
            background: #202225;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            gap: 8px;
            overflow-y: auto;
        }

        .server-icon {
            width: 48px;
            height: 48px;
            background: #5865f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            font-size: 18px;
            line-height: 1;
        }

        .server-icon:hover {
            border-radius: 16px;
            background: #677bc4;
        }

        .server-icon.active {
            border-radius: 16px;
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            box-shadow: 0 0 10px rgba(255, 105, 180, 0.3);
        }

        .server-icon.home {
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            padding: 0;
        }

        .server-icon.home img {
            width: 100%;
            height: 100%;
            border-radius: inherit;
        }

        .server-separator {
            width: 32px;
            height: 2px;
            background: linear-gradient(90deg, #FF69B4, #FF4500);
            border-radius: 1px;
            margin: 4px 0;
            opacity: 0.7;
        }

        .add-server {
            background: #36393f;
            color: #43b581;
            position: relative;
            font-size: 0; /* Hide the text + */
        }
        
        .add-server::before,
        .add-server::after {
            content: '';
            position: absolute;
            background: #43b581;
            border-radius: 1px;
            transform-origin: center;
            will-change: transform;
        }
        
        /* Horizontal bar */
        .add-server::before {
            width: 16px;
            height: 2px;
            top: 23px;
            left: 16px;
        }
        
        /* Vertical bar */
        .add-server::after {
            width: 2px;
            height: 16px;
            top: 16px;
            left: 23px;
        }

        .add-server:hover {
            background: #43b581;
            color: white;
        }
        
        .add-server:hover::before,
        .add-server:hover::after {
            background: white;
        }

        /* Channel Panel (Middle Panel) */
        .channel-panel {
            width: 240px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
        }

        .server-header {
            height: 48px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #202225;
            font-weight: bold;
            cursor: pointer;
        }

        .server-header:hover {
            background: #34373c;
        }

        .channels-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px 8px;
        }

        .channel-category {
            color: #8e9297;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            margin: 16px 8px 0;
            letter-spacing: 0.02em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .channel-manage-btn {
            background: none;
            border: none;
            color: #8e9297;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .channel-category:hover .channel-manage-btn {
            opacity: 1;
        }

        .channel-manage-btn:hover {
            background: #40444b;
            color: #dcddde;
        }

        .channel-list {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }

        .channel-item {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin: 1px 0;
            border-radius: 4px;
            cursor: pointer;
            color: #8e9297;
            font-size: 14px;
        }

        .channel-item:hover {
            background: #34373c;
            color: #dcddde;
        }

        .channel-item.active {
            background: linear-gradient(90deg, rgba(255, 105, 180, 0.2), rgba(255, 69, 0, 0.2));
            border-left: 3px solid #FF69B4;
            color: #ffffff;
        }

        .dm-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            color: #8e9297;
            font-size: 14px;
            transition: background-color 0.15s ease;
        }

        .dm-item:hover {
            background: #34373c;
            color: #dcddde;
        }

        .dm-item.active {
            background: linear-gradient(90deg, rgba(255, 105, 180, 0.2), rgba(255, 69, 0, 0.2));
            border-left: 3px solid #FF69B4;
            color: #ffffff;
        }

        .dm-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 12px;
            background: linear-gradient(45deg, #7289da, #5865f2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
            line-height: 1;
        }

        .dm-username {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dm-info {
            flex: 1;
            min-width: 0;
        }

        .dm-last-message {
            font-size: 12px;
            color: #72767d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .no-dms {
            text-align: center;
            color: #72767d;
            font-size: 14px;
            padding: 20px;
        }

        .channel-icon {
            width: 20px;
            margin-right: 6px;
            font-size: 16px;
        }

        .badge {
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            margin-left: auto;
            font-weight: bold;
        }

        .user-area {
            height: 52px;
            background: #292b2f;
            display: flex;
            align-items: center;
            padding: 0 8px;
        }

        .user-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            line-height: 1;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .username {
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        .user-status {
            font-size: 12px;
            color: #8e9297;
        }

        /* Chat Area (Main Panel) */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
            min-height: 0;
            height: 100%;
            overflow: hidden;
            transition: margin-right 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .chat-area.no-transition {
            transition: none !important;
        }

        .chat-area.expanded {
            margin-right: -240px; /* Expand into members panel space */
        }

        .members-panel {
            width: 240px;
            background: #2f3136;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #202225;
            transform: translateX(0);
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            z-index: 2;
            overflow: hidden;
            flex-shrink: 0;
        }

        .members-panel.collapsed {
            transform: translateX(100%); /* Slide completely out */
        }

        .members-header {
            height: 48px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #202225;
            color: #8e9297;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .members-count {
            color: #8e9297;
        }

        .members-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        /* Server Settings Member Items */
        #server-members-list .member-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            margin-bottom: 2px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
        }

        #server-members-list .member-item:hover {
            background-color: rgba(79, 84, 92, 0.3);
            transform: translateX(2px);
        }

        #server-members-list .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: white;
            margin-right: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #server-members-list .member-details {
            flex: 1;
        }

        #server-members-list .member-username {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }

        #server-members-list .member-role {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        #server-members-list .member-actions select {
            background: #40444b;
            color: #dcddde;
            border: 1px solid #4f545c;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #server-members-list .member-actions select:hover {
            border-color: #7289da;
            background: #36393f;
        }

        #server-members-list .member-actions select:focus {
            outline: none;
            border-color: #7289da;
            box-shadow: 0 0 0 2px rgba(114, 137, 218, 0.2);
        }

        .member-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #5865f2;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 12px;
            line-height: 1;
        }

        .member-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .member-name {
            font-weight: 500;
            font-size: 14px;
        }

        .member-role {
            font-size: 12px;
            color: #8e9297;
        }

        .chat-header {
            height: 48px;
            background: #36393f;
            border-bottom: 1px solid #202225;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .members-toggle-btn {
            background: #36393f;
            border: 1px solid #202225;
            color: #8e9297;
            font-size: 14px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px 0 0 4px;
            position: fixed;
            right: 240px; /* Start at panel edge */
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 10;
            width: 30px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .members-toggle-btn:hover {
            background: #40444b;
            color: #dcddde;
        }

        .members-toggle-btn.collapsed {
            right: 0; /* Move to right edge when panel is hidden */
            border-radius: 4px 0 0 4px;
            background: #5865f2;
            color: white;
        }

        /* Arrow rotation animation */
        .members-toggle-btn .arrow {
            transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: 16px;
        }

        .members-toggle-btn.collapsed .arrow {
            transform: rotate(180deg);
        }

        .channel-name {
            font-size: 16px;
            font-weight: bold;
            margin-left: 8px;
        }

        .channel-info {
            color: #8e9297;
            margin-left: 12px;
            font-size: 14px;
        }

        .messages-area {
            position: absolute;
            top: 48px; /* Below chat header */
            bottom: 0;
            left: 0;
            right: 0;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 120px; /* Add space for message input */
            background: #36393f;
        }

        .message {
            display: flex;
            margin-bottom: 16px;
            padding: 2px 0;
        }

        .message:hover {
            background: rgba(4, 4, 5, 0.07);
            margin: 0 -16px 16px;
            padding: 2px 16px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            margin-right: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 16px;
            color: white;
            line-height: 1;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
        }

        .message-author {
            font-weight: bold;
            color: white;
            margin-right: 8px;
        }

        .message-timestamp {
            font-size: 12px;
            color: #8e9297;
        }

        .message-text {
            color: #dcddde;
            line-height: 1.375;
            word-wrap: break-word;
        }

        .message-attachment {
            margin-top: 8px;
        }

        .message-image {
            max-width: 400px;
            max-height: 300px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        /* Image modal */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            cursor: pointer;
        }

        .image-modal img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        /* Message Input */
        .message-input-area {
            padding: 0 16px 24px;
            background: #36393f;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            border-top: 1px solid #40444b;
        }

        .message-input-container {
            background: #40444b;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            align-items: center;
        }

        .message-input {
            flex: 1;
            background: none;
            border: none;
            color: white;
            font-size: 14px;
            outline: none;
        }

        .message-input::placeholder {
            color: #8e9297;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-left: 12px;
        }

        .action-btn {
            background: none;
            border: none;
            color: #b9bbbe;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            font-size: 18px;
        }

        .action-btn:hover {
            color: #dcddde;
            background: #4f545c;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
        }

        .modal-content {
            background: #36393f;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 440px;
            color: white;
        }

        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            color: #8e9297;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: #202225;
            border: 1px solid #202225;
            border-radius: 4px;
            color: white;
            font-size: 16px;
        }

        .form-input:focus {
            border-color: #5865f2;
            outline: none;
        }

        .form-help {
            font-size: 12px;
            color: #8e9297;
            margin-top: 4px;
            line-height: 1.4;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn {
            padding: 10px 24px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #FF1493, #FF6347);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 105, 180, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: white;
        }

        .btn-secondary:hover {
            background: #4f545c;
        }

        /* Server Modal Tabs */
        .server-modal-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 2px solid #40444b;
        }

        .server-tab-btn {
            background: transparent;
            border: none;
            color: #8e9297;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .server-tab-btn:hover {
            color: #dcddde;
        }

        .server-tab-btn.active {
            color: #FF69B4;
        }

        .server-tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            border-radius: 1px;
        }

        .server-tab-content {
            display: none;
        }

        .server-tab-content.active {
            display: block;
        }

        /* File upload styling */
        .file-input {
            display: none;
        }

        /* Image preview area */
        .image-preview-area {
            display: none;
            padding: 8px 16px;
            background: #40444b;
            border-top: 1px solid #202225;
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            z-index: 11;
        }

        .image-preview-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            max-height: 120px;
            overflow-y: auto;
        }

        .image-preview {
            position: relative;
            display: inline-block;
        }

        .image-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 2px solid #202225;
        }

        .image-preview .remove-image {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            background: #f04747;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
        }

        /* Welcome message */
        .welcome-message {
            text-align: center;
            color: #8e9297;
            margin-top: 50px;
        }

        .welcome-message.dm-welcome {
            background: linear-gradient(135deg, rgba(255, 105, 180, 0.1), rgba(255, 69, 0, 0.1));
            border: 1px solid rgba(255, 105, 180, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
        }

        .welcome-message.dm-welcome h3 {
            color: #FF69B4;
            margin-bottom: 10px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 16px;
        }

        ::-webkit-scrollbar-track {
            background: #2e3136;
        }

        ::-webkit-scrollbar-thumb {
            background: #202225;
            border: 4px solid #2e3136;
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #1a1d23;
        }

        /* Search and profile views */
        .search-container {
            padding: 20px;
        }

        .search-bar {
            width: 100%;
            padding: 12px 16px;
            background: #40444b;
            border: 1px solid #202225;
            border-radius: 4px;
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
        }

        .search-bar:focus {
            border-color: #FF69B4;
            outline: none;
        }

        .user-result {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #2f3136;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .user-result:hover {
            background: #34373c;
        }

        .user-result .message-avatar {
            margin-right: 12px;
        }

        .user-info-text {
            flex: 1;
        }

        .user-result .username {
            font-weight: bold;
            color: white;
            font-size: 16px;
        }

        .user-result .user-email {
            color: #8e9297;
            font-size: 14px;
        }

        .add-friend-btn {
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .add-friend-btn:hover {
            background: linear-gradient(135deg, #FF1493, #FF6347);
        }

        /* Friends Main Area Styles */
        .friends-main-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 40px;
            background: var(--bg-primary);
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 20;
        }

        .friends-container {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            max-width: 1000px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .friends-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }

        .friends-header-main {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 30px;
        }

        .friends-header-main h2 {
            color: var(--text-primary);
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .friends-header-subtitle {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 16px;
        }

        .friends-nav-main {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
            justify-content: center;
            background: var(--bg-primary);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .friends-nav-btn-main {
            background: transparent;
            color: var(--text-secondary);
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            min-width: 120px;
        }

        .friends-nav-btn-main:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .friends-nav-btn-main.active {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .friends-nav-btn-main.active::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #ff6b6b;
        }

        .friends-content-main {
            flex: 1;
            overflow-y: auto;
            min-height: 400px;
        }

        .friends-tab-main {
            display: none;
        }

        .friends-tab-main.active {
            display: block;
        }

        /* Search Section */
        .search-section {
            margin-bottom: 30px;
            text-align: center;
        }

        .username-search-input {
            width: 100%;
            max-width: 600px;
            padding: 16px 20px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .username-search-input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
            transform: translateY(-1px);
        }

        .search-results-section {
            margin-top: 30px;
        }

        .username-search-results {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .search-placeholder {
            color: var(--text-secondary);
            text-align: center;
            padding: 60px;
            font-size: 18px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 2px dashed var(--border-color);
        }

        /* User Result Card */
        .user-result-card {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg-primary);
            border-radius: 10px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-result-card:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #ff6b6b;
        }

        .user-result-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin-right: 16px;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
            line-height: 1;
        }

        .user-result-info {
            flex: 1;
        }

        .user-result-username {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 4px;
        }

        .user-result-status {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .user-result-actions {
            display: flex;
            gap: 12px;
        }

        .quick-add-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
            line-height: 1;
        }

        .quick-add-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
        }

        /* Friends Grid */
        .friends-grid, .pending-requests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .friend-card {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .friend-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .friend-card:hover {
            background: var(--bg-hover);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-color: #ff6b6b;
        }

        .friend-card:hover::before {
            opacity: 1;
        }

        .friend-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .friend-card-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 22px;
            margin-right: 16px;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
            line-height: 1;
        }

        .friend-card-info {
            flex: 1;
        }

        .friend-card-username {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 6px;
        }

        .friend-card-status {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .friend-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .friend-action-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 80px;
            text-align: center;
        }

        .friend-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .friend-action-btn.primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .friend-action-btn.primary:hover {
            background: linear-gradient(135deg, #ee5a52, #dd4b4b);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .friend-action-btn.danger {
            background: #dc3545;
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .friend-action-btn.danger:hover {
            background: #c82333;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .user-profile-modal {
            background: #36393f;
            margin: 10% auto;
            padding: 0;
            border-radius: 8px;
            width: 500px;
            color: white;
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            height: 120px;
            position: relative;
        }

        .profile-avatar {
            position: absolute;
            bottom: -40px;
            left: 20px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            border: 6px solid #36393f;
        }

        .profile-content {
            padding: 50px 20px 20px;
        }

        .profile-username {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .profile-email {
            color: #8e9297;
            margin-bottom: 20px;
        }

        /* Server Settings Modal */
        .server-settings-modal {
            max-width: 800px;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
            max-height: 500px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .roles-section {
            padding: 10px 0;
        }

        .roles-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .roles-header h3 {
            margin: 0;
            color: white;
        }

        .role-form {
            background: #2f3136;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .permissions-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .permissions-list label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #dcddde;
            cursor: pointer;
        }

        .permissions-list input[type="checkbox"] {
            margin: 0;
        }

        .role-item {
            background: #2f3136;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .role-name {
            font-weight: bold;
            margin-right: 10px;
        }

        .role-actions {
            display: flex;
            gap: 10px;
        }

        .member-item {
            background: #2f3136;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF69B4, #FF4500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }

        .member-details {
            display: flex;
            flex-direction: column;
        }

        .member-username {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .member-role {
            font-size: 12px;
            color: #b9bbbe;
        }

        .member-actions select {
            background: #40444b;
            color: white;
            border: 1px solid #72767d;
            border-radius: 4px;
            padding: 5px 10px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #dcddde;
            font-size: 24px;
            cursor: pointer;
            float: right;
        }

        .close-btn:hover {
            color: white;
        }
    </style>
</head>
<body>
    <div class="discord-container">
        <!-- Server List -->
        <div class="server-list">
            <div class="server-icon home active" data-server="home" onclick="selectHome()">
                <img src="logo.svg" alt="Enyalis" style="width: 42px; height: 42px; object-fit: contain;">
            </div>
            <div class="server-separator"></div>
            <!-- User servers will be populated here -->
            <div id="user-servers"></div>
            <div class="server-icon add-server" onclick="showServerModal()" title="Add Server">+</div>
        </div>

        <!-- Channel Panel -->
        <div class="channel-panel">
            <div class="server-header" id="server-header">
                <span id="current-server-name" onclick="showServerMenu()" style="cursor: pointer; flex: 1;">Direct Messages</span>
                <div style="margin-left: auto; display: flex; gap: 8px;">
                    <button id="invite-btn" class="action-btn" onclick="showInviteModal()" style="display: none;" title="Invite People">ðŸ‘¥</button>
                </div>
            </div>
            
            <div class="channels-container">
                <!-- Friends section for home -->
                <div id="friends-section">
                    <div class="channel-category">Friends</div>
                    <ul class="channel-list" id="dm-list">
                        <li class="channel-item" onclick="showFriendsMain()" data-view="friends">
                            <span class="channel-icon">ðŸ‘¥</span>
                            Friends
                        </li>
                    </ul>
                    
                    <div class="channel-category">Direct Messages</div>
                    <ul class="channel-list" id="dm-conversations">
                        <!-- DM conversations will be populated here -->
                    </ul>
                </div>

                <!-- Server channels section -->
                <div id="server-channels-section" style="display: none;">
                    <div class="channel-category">
                        <span>Text Channels</span>
                        <button class="channel-manage-btn" id="add-channel-btn" onclick="showCreateChannelModal()" title="Create Channel">+</button>
                    </div>
                    <ul class="channel-list" id="text-channels-list"></ul>
                </div>
            </div>

            <div class="user-area">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar"></div>
                    <div class="user-details">
                        <div class="username" id="current-username">Loading...</div>
                        <div class="user-status">Online</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chat-area">
            <div class="chat-header">
                <span class="channel-icon" id="header-icon">#</span>
                <span class="channel-name" id="current-channel-name">Welcome</span>
                <span class="channel-info" id="current-channel-info">Select a server to get started</span>
            </div>

            <div class="messages-area" id="messages-container">
                <div class="welcome-message" id="default-welcome">
                    <h3>ðŸŽ‰ Welcome to Enyalis!</h3>
                    <p>Create a server or join one with an invite code to start chatting.</p>
                </div>
            </div>

            <!-- Message Input Area -->
            <div class="image-preview-area" id="image-preview-area">
                <div class="image-preview-container" id="image-preview-container"></div>
            </div>

            <div class="message-input-area" id="message-input-area" style="display: none;">
                <div class="message-input-container">
                    <input type="file" class="file-input" id="image-input" accept="image/*" multiple>
                    <input type="text" class="message-input" id="message-input" placeholder="Message...">
                    <div class="message-actions">
                        <button class="action-btn" onclick="document.getElementById('image-input').click()">ðŸ“Ž</button>
                        <button class="action-btn" id="send-btn" onclick="sendMessage()">âž¤</button>
                    </div>
                </div>
            </div>
            
            <!-- Central Friends UI -->
            <div class="friends-main-area" id="friends-main-area" style="display: none;">
                <div class="friends-container">
                    <div class="friends-header-main">
                        <h2>Friends</h2>
                        <div class="friends-header-subtitle">Manage your connections and discover new friends</div>
                    </div>
                    
                    <div class="friends-nav-main">
                        <button class="friends-nav-btn-main active" onclick="switchFriendsTab('current')">
                            Current Friends
                        </button>
                        <button class="friends-nav-btn-main" onclick="switchFriendsTab('add')">
                            Add Friends
                        </button>
                        <button class="friends-nav-btn-main" onclick="switchFriendsTab('pending')">
                            Pending Requests
                        </button>
                    </div>
                    
                    <div class="friends-content-main">
                        <!-- Current Friends Tab -->
                        <div id="current-friends-content" class="friends-tab-main active">
                            <div class="friends-grid" id="current-friends-grid">
                                <!-- Current friends will be loaded here -->
                            </div>
                        </div>
                        
                        <!-- Add Friends Tab -->
                        <div id="add-friends-content" class="friends-tab-main">
                            <div class="search-section">
                                <input 
                                    type="text" 
                                    id="username-search-input" 
                                    placeholder="Enter username to search..." 
                                    class="username-search-input"
                                >
                            </div>
                            <div class="search-results-section">
                                <div id="username-search-results" class="username-search-results">
                                    <div class="search-placeholder">Enter a username to find friends</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pending Requests Tab -->
                        <div id="pending-requests-content" class="friends-tab-main">
                            <div class="pending-requests-grid" id="pending-requests-grid">
                                <!-- Pending requests will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Members Panel -->
        <div class="members-panel" id="members-panel" style="display: none;">
            <div class="members-header">
                <span>Members</span>
                <span class="members-count" id="members-count">0</span>
            </div>
            <div class="members-list" id="members-list">
                <!-- Members will be populated here -->
            </div>
        </div>
        
        <!-- Floating Members Toggle Button -->
        <button class="members-toggle-btn" id="members-toggle" onclick="toggleMembersPanel()" title="Toggle Members" style="display: none;">
            <span class="arrow">â—„</span>
        </button>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="image-modal" onclick="closeImageModal()">
        <img id="modal-image" src="" alt="">
    </div>

    <!-- Unified Server Modal -->
    <div id="server-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="server-modal-title">Add Server</span>
            </div>
            
            <!-- Tab Navigation -->
            <div class="server-modal-tabs">
                <button class="server-tab-btn active" id="create-tab-btn" onclick="switchServerTab('create')">
                    Create Server
                </button>
                <button class="server-tab-btn" id="join-tab-btn" onclick="switchServerTab('join')">
                    Join Server
                </button>
            </div>
            
            <!-- Create Server Tab -->
            <div id="create-server-tab" class="server-tab-content active">
                <form id="create-server-form" onsubmit="createServer(event)">
                    <div class="form-group">
                        <label class="form-label">Server Name</label>
                        <input type="text" class="form-input" id="server-name" placeholder="Enter server name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Server Description</label>
                        <input type="text" class="form-input" id="server-description" placeholder="What's your server about?">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideServerModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Server</button>
                    </div>
                </form>
            </div>
            
            <!-- Join Server Tab -->
            <div id="join-server-tab" class="server-tab-content">
                <form id="join-server-form" onsubmit="joinServer(event)">
                    <div class="form-group">
                        <label class="form-label">Invite Code or Link</label>
                        <input type="text" class="form-input" id="invite-code" placeholder="Enter invite code (e.g., ABC123) or paste invite link" required>
                        <small class="form-help">You can paste a full invite link or just enter the code</small>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideServerModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Join Server</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Friend Modal -->
    <div id="add-friend-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add Friend</div>
            <form id="add-friend-form" onsubmit="sendFriendRequest(event)">
                <div class="form-group">
                    <label class="form-label">Username or Email</label>
                    <input type="text" class="form-input" id="friend-identifier" placeholder="Enter username or email" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideAddFriendModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Request</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Server Invite Modal -->
    <div id="server-invite-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Invite People to <span id="invite-server-name"></span></div>
            <div class="form-group">
                <label class="form-label">Share this invite link</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" class="form-input" id="invite-link" readonly>
                    <button type="button" class="btn btn-primary" onclick="copyInviteLink()">Copy</button>
                </div>
                <div style="font-size: 12px; color: #8e9297; margin-top: 8px;">
                    This invite link never expires and can be used by anyone.
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideInviteModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Channel Modal -->
    <div id="create-channel-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Create Channel</div>
            <form onsubmit="createChannel(event)">
                <div class="form-group">
                    <label class="form-label">Channel Name</label>
                    <input type="text" class="form-input" id="channel-name" placeholder="new-channel" required>
                    <div class="form-help">Channel names must be lowercase and can contain letters, numbers, and hyphens.</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Channel Description</label>
                    <input type="text" class="form-input" id="channel-description" placeholder="What's this channel about?">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateChannelModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Channel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="user-profile-modal" class="modal">
        <div class="user-profile-modal">
            <div class="profile-header">
                <div class="profile-avatar" id="profile-avatar"></div>
            </div>
            <div class="profile-content">
                <div class="profile-username" id="profile-username"></div>
                <div class="profile-email" id="profile-email"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-primary" id="profile-add-friend-btn" onclick="sendFriendRequestToProfile()">Add Friend</button>
                    <button type="button" class="btn btn-secondary" onclick="hideUserProfile()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Settings Modal -->
    <div id="server-settings-modal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow: hidden;">
            <div class="modal-header">
                <span id="server-settings-title">Server Settings</span>
                <button type="button" class="close-btn" onclick="hideServerSettings()">&times;</button>
            </div>
            
            <div class="server-modal-tabs">
                <button class="tab-btn active" onclick="switchServerSettingsTab('general')">General</button>
                <button class="tab-btn" onclick="switchServerSettingsTab('members')">Members</button>
                <button class="tab-btn" onclick="switchServerSettingsTab('roles')">Roles</button>
            </div>
            
            <!-- General Settings Tab -->
            <div id="general-tab" class="tab-content active">
                <form onsubmit="updateServerSettings(event)">
                    <div class="form-group">
                        <label class="form-label">Server Name</label>
                        <input type="text" class="form-input" id="edit-server-name" placeholder="Server Name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-input" id="edit-server-description" placeholder="What's your server about?" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Server Image</label>
                        <input type="file" class="form-input" id="edit-server-image" accept="image/*">
                        <div class="form-help">Upload an image for your server icon</div>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
            
            <!-- Members Management Tab -->
            <div id="members-tab" class="tab-content">
                <div class="members-list-container" style="max-height: 400px; overflow-y: auto;">
                    <div id="server-members-list">
                        <!-- Members will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Roles Management Tab -->
            <div id="roles-tab" class="tab-content">
                <div class="roles-section">
                    <div class="roles-header">
                        <h3>Roles</h3>
                        <button type="button" class="btn btn-primary btn-sm" onclick="showCreateRoleForm()">Create Role</button>
                    </div>
                    
                    <!-- Create Role Form (initially hidden) -->
                    <div id="create-role-form" class="role-form" style="display: none;">
                        <form onsubmit="createRole(event)">
                            <div class="form-group">
                                <label class="form-label">Role Name</label>
                                <input type="text" class="form-input" id="new-role-name" placeholder="Role Name" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Role Color</label>
                                <input type="color" class="form-input" id="new-role-color" value="#5865f2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Permissions</label>
                                <div class="permissions-list">
                                    <label><input type="checkbox" id="perm-manage-channels"> Manage Channels</label>
                                    <label><input type="checkbox" id="perm-manage-members"> Manage Members</label>
                                    <label><input type="checkbox" id="perm-kick-members"> Kick Members</label>
                                    <label><input type="checkbox" id="perm-ban-members"> Ban Members</label>
                                    <label><input type="checkbox" id="perm-create-invite"> Create Invite</label>
                                </div>
                            </div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideCreateRoleForm()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Create Role</button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="roles-list">
                        <!-- Roles will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let currentUser = null;
        let currentServer = null;
        let currentChannel = null;
        let userServers = [];
        let friends = [];
        let friendRequests = { incoming: [], outgoing: [] };
        let allUsers = [];
        let currentView = 'welcome';
        let currentProfileUser = null;
        let currentDMUser = null;

        // Authentication check
        async function validateSession() {
            const token = localStorage.getItem('token');
            if (!token) {
                redirectToLandingWithError('Please log in to access the chat.');
                return false;
            }

            try {
                const response = await fetch('/api/users/validate', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Session validation failed');
                }

                const userData = await response.json();
                currentUser = userData.user;
                return true;
            } catch (error) {
                console.error('Session validation error:', error);
                localStorage.removeItem('token');
                redirectToLandingWithError('Your session has expired. Please log in again.');
                return false;
            }
        }

        function redirectToLandingWithError(message) {
            localStorage.setItem('authError', message);
            window.location.href = '/';
        }

        // Initialize everything on page load
        window.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await validateSession();
            if (!isAuthenticated) {
                return;
            }

            // Update UI with current user info
            document.getElementById('current-username').textContent = currentUser.username;
            document.getElementById('user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();
            
            // Initialize Socket.IO and load data
            initializeSocket();
            loadUserServers();
            // Initialize with friends view
            showFriendsMain();
            loadDMConversations();
            
            // Set up message input event listener
            document.getElementById('message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Set up image input change listener
            document.getElementById('image-input').addEventListener('change', handleImageSelection);
        });

        function initializeSocket() {
            const token = localStorage.getItem('token');
            socket = io({
                auth: {
                    token: token
                }
            });
            
            socket.on('connect', () => {
                console.log('Connected to server with authentication');
            });

            socket.on('connect_error', (error) => {
                console.error('Socket connection failed:', error);
                redirectToLandingWithError('Authentication failed. Please log in again.');
            });
            
            socket.on('new-message', (message) => {
                console.log('Received new message via socket:', message);
                console.log('Current channel:', currentChannel);
                if (currentChannel && parseInt(message.channelId) === parseInt(currentChannel.id)) {
                    console.log('Adding message to UI');
                    addMessageToUI(message);
                } else {
                    console.log('Message not for current channel or no current channel');
                    console.log('Message channel ID:', message.channelId, 'Current channel ID:', currentChannel?.id);
                }
            });
            
            // Listen for friend request notifications
            socket.on('friend-request-received', (data) => {
                console.log('Friend request received:', data);
                showNotification(data.message, 'success');
                // Update friend requests badge and reload pending requests if on friends page
                loadFriendRequests();
                if (currentView === 'friends') {
                    loadPendingRequestsMain();
                }
            });
            
            // Listen for direct messages
            socket.on('new-direct-message', (message) => {
                console.log('Received new DM:', message);
                console.log('Current DM user:', currentDMUser);
                console.log('Current view:', currentView);
                
                if (currentView === 'dm' && currentDMUser && 
                    (message.senderId == currentDMUser.id || message.recipientId == currentDMUser.id)) {
                    console.log('Adding DM to UI');
                    addMessageToUI(message);
                    
                    // Update DM list if sender is not current user
                    if (message.senderId !== parseInt(localStorage.getItem('userId'))) {
                        const sender = { id: message.senderId, username: message.username };
                        addToDMList(sender);
                    }
                    
                    // Update direct messages cache and refresh DM list
                    const otherUserId = message.senderId === parseInt(localStorage.getItem('userId')) ? message.recipientId : message.senderId;
                    let userMessages = directMessages.get(otherUserId) || [];
                    userMessages.push(message);
                    directMessages.set(otherUserId, userMessages);
                    updateDMList();
                } else {
                    console.log('DM not for current conversation - message for:', message.senderId, message.recipientId, 'current user:', currentDMUser?.id);
                    
                    // Still add to cache and update DM list for other conversations
                    const otherUserId = message.senderId === parseInt(localStorage.getItem('userId')) ? message.recipientId : message.senderId;
                    let userMessages = directMessages.get(otherUserId) || [];
                    userMessages.push(message);
                    directMessages.set(otherUserId, userMessages);
                    
                    // Add sender to DM list if not current user
                    if (message.senderId !== parseInt(localStorage.getItem('userId'))) {
                        const sender = { id: message.senderId, username: message.username };
                        addToDMList(sender);
                    }
                }
            });
        }

        // Load user's servers
        async function loadUserServers() {
            try {
                const response = await fetch('/api/servers', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    userServers = data.servers;
                    displayUserServers();
                }
            } catch (error) {
                console.error('Error loading servers:', error);
            }
        }

        // Display servers in the sidebar
        function displayUserServers() {
            const serversContainer = document.getElementById('user-servers');
            serversContainer.innerHTML = '';

            console.log('=== Displaying user servers ===');
            console.log('userServers:', userServers);

            userServers.forEach((server, index) => {
                console.log(`Server ${index}:`, server);
                console.log(`Server ${index} keys:`, Object.keys(server));
                console.log(`Server ${index} id:`, server.id, typeof server.id);
                
                const serverIcon = document.createElement('div');
                serverIcon.className = 'server-icon';
                serverIcon.dataset.serverId = server.id;
                serverIcon.onclick = () => {
                    console.log('Server icon clicked, server object:', server);
                    selectServer(server);
                };
                serverIcon.title = server.name;
                
                // Use first letter of server name as icon
                serverIcon.textContent = server.name.charAt(0).toUpperCase();
                
                serversContainer.appendChild(serverIcon);
            });
        }

        // Server selection functions
        function selectHome() {
            currentServer = null;
            currentChannel = null;
            
            // Update UI
            document.querySelector('.server-icon.active').classList.remove('active');
            document.querySelector('.server-icon.home').classList.add('active');
            
            document.getElementById('current-server-name').textContent = 'Direct Messages';
            document.getElementById('friends-section').style.display = 'block';
            document.getElementById('server-channels-section').style.display = 'none';
            document.getElementById('invite-btn').style.display = 'none';
            
            // Hide members panel when not in a server
            hideMembersPanel();
            
            // Show friends main area
            showFriendsMain();
        }

        async function selectServer(server) {
            console.log('=== selectServer called ===');
            console.log('Input server object:', server);
            console.log('Input server keys:', Object.keys(server));
            console.log('Input server.id:', server.id, typeof server.id);
            
            currentServer = server;
            console.log('currentServer set to:', currentServer);
            console.log('currentServer.id after assignment:', currentServer.id, typeof currentServer.id);
            
            currentView = 'server';
            
            // Update UI
            document.querySelector('.server-icon.active')?.classList.remove('active');
            document.querySelector(`[data-server-id="${server.id}"]`)?.classList.add('active');
            
            // Hide friends UI and show messages area
            document.getElementById('friends-main-area').style.display = 'none';
            document.getElementById('messages-container').style.display = 'block';
            document.getElementById('friends-section').style.display = 'none';
            document.getElementById('server-channels-section').style.display = 'block';
            document.getElementById('invite-btn').style.display = 'block';
            document.getElementById('message-input-area').style.display = 'block';
            
            // Show members panel for servers (will restore saved state)
            showMembersPanel();
            
            document.getElementById('current-server-name').textContent = server.name;
            
            console.log('About to load channels and members...');
            console.log('currentServer before loading:', currentServer);
            
            // Load server channels and members
            await loadServerChannels(server.id);
            await loadServerMembers(server.id);
            
            console.log('currentServer after loading channels/members:', currentServer);
            
            // Check if user has permission to manage channels
            checkChannelManagementPermission(server.id);
        }

        // Load channels for a server
        async function loadServerChannels(serverId) {
            console.log('Loading channels for server:', serverId);
            try {
                const response = await fetch(`/api/servers/${serverId}/channels`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Received channels:', data);
                    displayChannels(data.channels);
                    
                    // Auto-select first channel
                    if (data.channels.length > 0) {
                        console.log('Auto-selecting first channel:', data.channels[0]);
                        await selectChannel(data.channels[0]);
                    }
                } else {
                    console.error('Failed to load channels:', response.status, await response.text());
                }
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }

        // Display channels
        function displayChannels(channels) {
            console.log('Displaying channels:', channels);
            const textChannelsList = document.getElementById('text-channels-list');
            textChannelsList.innerHTML = '';

            const textChannels = channels.filter(ch => ch.type === 'text');
            
            textChannels.forEach(channel => {
                const channelItem = document.createElement('li');
                channelItem.className = 'channel-item';
                channelItem.dataset.channelId = channel.id;
                channelItem.onclick = () => selectChannel(channel);
                
                channelItem.innerHTML = `
                    <span class="channel-icon">#</span>
                    ${channel.name}
                `;
                
                textChannelsList.appendChild(channelItem);
            });
        }

        // Select a channel
        async function selectChannel(channel) {
            console.log('Selecting channel:', channel);
            currentChannel = channel;
            currentView = 'server';
            
            // Update UI - find the correct channel item by data attribute
            document.querySelectorAll('.channel-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.channelId == channel.id) {
                    item.classList.add('active');
                }
            });
            
            document.getElementById('header-icon').textContent = '#';
            document.getElementById('current-channel-name').textContent = channel.name;
            document.getElementById('current-channel-info').textContent = `${currentServer.name} â€¢ ${channel.name}`;
            document.getElementById('message-input-area').style.display = 'block';
            
            // Join channel room
            if (socket) {
                socket.emit('join-channel', channel.id);
            }
            
            // Load messages
            await loadMessages(channel.id);
        }

        // Load messages for a channel
        async function loadMessages(channelId) {
            console.log('Loading messages for channel:', channelId);
            try {
                const response = await fetch(`/api/messages/channel/${channelId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                console.log('Load messages response:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('Received messages:', data);
                    displayMessages(data.messages);
                } else {
                    const error = await response.text();
                    console.error('Failed to load messages:', response.status, error);
                }
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display messages
        function displayMessages(messages) {
            console.log('Displaying messages:', messages);
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';

            if (messages.length === 0) {
                console.log('No messages, showing welcome');
                
                if (currentView === 'dm' && currentDMUser) {
                    // Show DM welcome message
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'welcome-message dm-welcome';
                    welcomeDiv.innerHTML = `
                        <h3>ðŸ’¬ Direct Message with ${currentDMUser.username}</h3>
                        <p>This is the beginning of your direct message conversation with ${currentDMUser.username}. Say hello!</p>
                    `;
                    messagesContainer.appendChild(welcomeDiv);
                } else {
                    // Show channel welcome message when no messages
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'welcome-message';
                    welcomeDiv.innerHTML = `
                        <h3>Welcome to #${currentChannel ? currentChannel.name : 'general'}!</h3>
                        <p>This is the beginning of the #${currentChannel ? currentChannel.name : 'general'} channel. Start chatting to see your messages here!</p>
                    `;
                    messagesContainer.appendChild(welcomeDiv);
                }
            } else {
                console.log('Found messages, adding to UI:', messages.length);
                messages.forEach(message => {
                    addMessageToUI(message);
                });
            }

            scrollToBottom();
        }

        // Add message to UI
        function addMessageToUI(message) {
            console.log('Adding message to UI:', message);
            const messagesContainer = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            // Handle both DM messages (createdAt) and channel messages (timestamp)
            const messageTime = message.createdAt || message.timestamp;
            const messageText = message.text || message.content || '';
            
            if (!messageTime) {
                console.error('No timestamp found in message:', message);
                return;
            }
            
            const timeAgo = getTimeAgo(new Date(messageTime));
            const actualTime = new Date(messageTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${message.username.charAt(0).toUpperCase()}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">${message.username}</span>
                        <span class="message-timestamp">${timeAgo} at ${actualTime}</span>
                    </div>
                    <div class="message-text">${escapeHtml(messageText)}</div>
                    ${message.attachments && message.attachments.length > 0 ? 
                        message.attachments.map(att => 
                            att.type === 'image' ? 
                                `<div class="message-attachment"><img src="${att.url}" alt="${att.filename}" class="message-image" onclick="openImageModal('${att.url}')"></div>` : 
                                `<div class="message-attachment">ðŸ“Ž ${att.filename}</div>`
                        ).join('') : ''}
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            console.log('Message added to UI successfully');
        }

        // Send message
        async function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const imageInput = document.getElementById('image-input');
            const text = messageInput.value.trim();
            const files = imageInput.files;
            
            console.log('Sending message:', text, 'Current view:', currentView, 'Current channel:', currentChannel);
            
            if (!text && files.length === 0) return;
            
            try {
                const formData = new FormData();
                formData.append('text', text);
                
                // Check if we're in DM or channel mode
                if (currentView === 'dm' && currentDMUser) {
                    formData.append('recipientId', currentDMUser.id);
                    formData.append('type', 'dm');
                    console.log('Sending DM to:', currentDMUser);
                } else if (currentChannel) {
                    formData.append('channelId', currentChannel.id);
                    formData.append('type', 'channel');
                    console.log('Sending channel message to:', currentChannel);
                } else {
                    console.log('No valid target for message');
                    return; // No valid target
                }
                
                // Add selected images
                for (let i = 0; i < files.length; i++) {
                    formData.append('images', files[i]);
                }
                
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                        // Don't set Content-Type header - let browser set it for FormData
                    },
                    body: formData
                });

                console.log('Message send response:', response.status);
                if (response.ok) {
                    const result = await response.json();
                    console.log('Message sent successfully:', result);
                    messageInput.value = '';
                    imageInput.value = ''; // Clear selected images
                    clearImagePreviews(); // Clear preview area
                } else {
                    const error = await response.text();
                    console.error('Failed to send message:', response.status, error);
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Handle image selection
        function handleImageSelection(event) {
            const files = event.target.files;
            const previewArea = document.getElementById('image-preview-area');
            const previewContainer = document.getElementById('image-preview-container');
            
            if (files.length > 0) {
                previewArea.style.display = 'block';
                previewContainer.innerHTML = '';
                
                Array.from(files).forEach((file, index) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'image-preview';
                            previewDiv.innerHTML = `
                                <img src="${e.target.result}" alt="${file.name}">
                                <button class="remove-image" onclick="removeImagePreview(${index})">Ã—</button>
                            `;
                            previewContainer.appendChild(previewDiv);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            } else {
                previewArea.style.display = 'none';
            }
        }

        // Remove image preview
        function removeImagePreview(index) {
            const imageInput = document.getElementById('image-input');
            const files = Array.from(imageInput.files);
            
            // Create new FileList without the removed file
            const dt = new DataTransfer();
            files.forEach((file, i) => {
                if (i !== index) {
                    dt.items.add(file);
                }
            });
            
            imageInput.files = dt.files;
            handleImageSelection({ target: imageInput });
        }

        // Clear image previews
        function clearImagePreviews() {
            const previewArea = document.getElementById('image-preview-area');
            const previewContainer = document.getElementById('image-preview-container');
            
            previewArea.style.display = 'none';
            previewContainer.innerHTML = '';
        }

        // Image modal functions
        function openImageModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            
            modalImage.src = imageSrc;
            modal.style.display = 'block';
        }

        function closeImageModal() {
            document.getElementById('image-modal').style.display = 'none';
        }

        // Server management functions
        // Unified Server Modal Functions
        function showServerModal(tab = 'create') {
            document.getElementById('server-modal').style.display = 'block';
            switchServerTab(tab);
        }

        function hideServerModal() {
            document.getElementById('server-modal').style.display = 'none';
            document.getElementById('create-server-form').reset();
            document.getElementById('join-server-form').reset();
        }

        function switchServerTab(tab) {
            // Remove active class from all tabs
            document.querySelectorAll('.server-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.server-tab-content').forEach(content => content.classList.remove('active'));
            
            // Activate selected tab
            document.getElementById(`${tab}-tab-btn`).classList.add('active');
            document.getElementById(`${tab}-server-tab`).classList.add('active');
            
            // Update modal title
            const title = tab === 'create' ? 'Create Your Server' : 'Join a Server';
            document.getElementById('server-modal-title').textContent = title;
        }

        async function createServer(event) {
            event.preventDefault();
            
            const name = document.getElementById('server-name').value.trim();
            const description = document.getElementById('server-description').value.trim();
            
            try {
                const response = await fetch('/api/servers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    hideServerModal();
                    await loadUserServers(); // Reload servers
                    
                    const data = await response.json();
                    selectServer(data.server); // Auto-select new server
                }
            } catch (error) {
                console.error('Error creating server:', error);
            }
        }

        async function joinServer(event) {
            event.preventDefault();
            
            let inviteInput = document.getElementById('invite-code').value.trim();
            
            // Extract invite code from URL if it's a full invite link
            let inviteCode = inviteInput;
            if (inviteInput.includes('/invite/')) {
                // Extract code from URL like "http://localhost:3000/invite/ABC123"
                const matches = inviteInput.match(/\/invite\/([A-Za-z0-9]+)/);
                if (matches && matches[1]) {
                    inviteCode = matches[1];
                }
            }
            
            if (!inviteCode) {
                alert('Please enter a valid invite code or link');
                return;
            }
            
            try {
                const response = await fetch('/api/servers/join', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ inviteCode })
                });

                if (response.ok) {
                    const result = await response.json();
                    hideServerModal();
                    await loadUserServers(); // Reload servers
                    showNotification(`Successfully joined "${result.serverName}"!`, 'success');
                } else {
                    const error = await response.json();
                    alert(error.message || 'Failed to join server');
                }
            } catch (error) {
                console.error('Error joining server:', error);
                alert('Failed to join server. Please try again.');
            }
        }

        // Show welcome message
        function showWelcomeMessage() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = `
                <div class="welcome-message">
                    <h3>ðŸŽ‰ Welcome to Enyalis!</h3>
                    <p>Create a server or join one with an invite code to start chatting.</p>
                    <br>
                    <button class="btn btn-primary" onclick="showServerModal('create')">Create Server</button>
                    <button class="btn btn-secondary" onclick="showServerModal('join')" style="margin-left: 12px;">Join Server</button>
                </div>
            `;
        }

        function showFriends() {
            document.querySelectorAll('#friends-section .channel-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.channel-item').classList.add('active');
            
            document.getElementById('header-icon').textContent = 'ðŸ‘¥';
            document.getElementById('current-channel-name').textContent = 'Friends';
            document.getElementById('current-channel-info').textContent = `${friends.length} friends`;
            
            displayFriendsList();
        }

        function showFriendRequests() {
            document.querySelectorAll('#friends-section .channel-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.channel-item').classList.add('active');
            
            document.getElementById('header-icon').textContent = 'ðŸ“¨';
            document.getElementById('current-channel-name').textContent = 'Friend Requests';
            document.getElementById('current-channel-info').textContent = `${friendRequests.incoming.length} pending`;
            
            displayFriendRequests();
        }

        function showAddFriend() {
            document.getElementById('add-friend-modal').style.display = 'block';
        }

        function hideAddFriendModal() {
            document.getElementById('add-friend-modal').style.display = 'none';
            document.getElementById('add-friend-form').reset();
        }

        // Load friends
        async function loadFriends() {
            try {
                const response = await fetch('/api/friends', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    friends = data.friends;
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        // Load friend requests
        async function loadFriendRequests() {
            try {
                const response = await fetch('/api/friends/requests', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    friendRequests = data;
                    updateFriendRequestsBadge();
                }
            } catch (error) {
                console.error('Error loading friend requests:', error);
            }
        }

        // Update friend requests badge
        function updateFriendRequestsBadge() {
            const badge = document.getElementById('friend-requests-badge');
            if (!badge) {
                console.log('Friend requests badge element not found - skipping badge update');
                return;
            }
            
            if (friendRequests.incoming.length > 0) {
                badge.textContent = friendRequests.incoming.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        // Send friend request
        async function sendFriendRequest(event) {
            event.preventDefault();
            
            const identifier = document.getElementById('friend-identifier').value.trim();
            
            try {
                const body = identifier.includes('@') ? 
                    { email: identifier } : 
                    { username: identifier };
                
                const response = await fetch('/api/friends/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (response.ok) {
                    hideAddFriendModal();
                    alert('Friend request sent successfully!');
                    loadFriendRequests();
                } else {
                    alert(data.error || 'Failed to send friend request');
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
                alert('Failed to send friend request');
            }
        }

        // Accept friend request
        async function acceptFriendRequest(requestId) {
            try {
                const response = await fetch(`/api/friends/accept/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    await loadFriends();
                    await loadFriendRequests();
                    showFriends();
                }
            } catch (error) {
                console.error('Error accepting friend request:', error);
            }
        }

        // Decline friend request
        async function declineFriendRequest(requestId) {
            try {
                const response = await fetch(`/api/friends/decline/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    await loadFriendRequests();
                    showFriendRequests();
                }
            } catch (error) {
                console.error('Error declining friend request:', error);
            }
        }

        // Display friends list
        function displayFriendsList() {
            const messagesContainer = document.getElementById('messages-container');
            
            if (friends.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <h3>ðŸ‘¥ No Friends Yet</h3>
                        <p>Add friends to start direct messaging and see who's online!</p>
                        <br>
                        <button class="btn btn-primary" onclick="showAddFriend()">Add Friend</button>
                    </div>
                `;
                return;
            }
            
            messagesContainer.innerHTML = `
                <div style="padding: 20px;">
                    <div style="display: grid; gap: 12px;">
                        ${friends.map(friend => `
                            <div style="display: flex; align-items: center; padding: 12px; background: #2f3136; border-radius: 8px;">
                                <div class="message-avatar" style="margin-right: 12px; width: 32px; height: 32px; font-size: 14px;">
                                    ${friend.username.charAt(0).toUpperCase()}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: white;">${friend.username}</div>
                                    <div style="font-size: 12px; color: #8e9297;">Friends since ${new Date(friend.friendsSince).toLocaleDateString()}</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">Message</button>
                                    <button class="btn btn-secondary" onclick="removeFriend(${friend.id})" style="padding: 6px 12px; font-size: 12px; background: #f04747;">Remove</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Display friend requests
        function displayFriendRequests() {
            const messagesContainer = document.getElementById('messages-container');
            
            if (friendRequests.incoming.length === 0 && friendRequests.outgoing.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome-message">
                        <h3>ðŸ“¨ No Friend Requests</h3>
                        <p>When someone sends you a friend request, it will appear here.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="padding: 20px;">';
            
            if (friendRequests.incoming.length > 0) {
                html += `
                    <h4 style="color: white; margin-bottom: 12px;">Incoming Requests</h4>
                    <div style="display: grid; gap: 12px; margin-bottom: 24px;">
                        ${friendRequests.incoming.map(request => `
                            <div style="display: flex; align-items: center; padding: 12px; background: #2f3136; border-radius: 8px;">
                                <div class="message-avatar" style="margin-right: 12px; width: 32px; height: 32px; font-size: 14px;">
                                    ${request.senderUsername.charAt(0).toUpperCase()}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: white;">${request.senderUsername}</div>
                                    <div style="font-size: 12px; color: #8e9297;">Sent ${new Date(request.createdAt).toLocaleDateString()}</div>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-primary" onclick="acceptFriendRequest('${request.id}')" style="padding: 6px 12px; font-size: 12px;">Accept</button>
                                    <button class="btn btn-secondary" onclick="declineFriendRequest('${request.id}')" style="padding: 6px 12px; font-size: 12px;">Decline</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            if (friendRequests.outgoing.length > 0) {
                html += `
                    <h4 style="color: white; margin-bottom: 12px;">Outgoing Requests</h4>
                    <div style="display: grid; gap: 12px;">
                        ${friendRequests.outgoing.map(request => `
                            <div style="display: flex; align-items: center; padding: 12px; background: #2f3136; border-radius: 8px;">
                                <div class="message-avatar" style="margin-right: 12px; width: 32px; height: 32px; font-size: 14px;">
                                    ${request.receiverUsername.charAt(0).toUpperCase()}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: white;">${request.receiverUsername}</div>
                                    <div style="font-size: 12px; color: #8e9297;">Pending since ${new Date(request.createdAt).toLocaleDateString()}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            html += '</div>';
            messagesContainer.innerHTML = html;
        }

        // Remove friend
        async function removeFriend(friendId) {
            if (!confirm('Are you sure you want to remove this friend?')) return;
            
            try {
                const response = await fetch(`/api/friends/${friendId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    await loadFriends();
                    displayFriendsList();
                }
            } catch (error) {
                console.error('Error removing friend:', error);
            }
        }

        // Server invite functions
        function showInviteModal() {
            if (!currentServer) return;
            
            document.getElementById('invite-server-name').textContent = currentServer.name;
            document.getElementById('invite-link').value = `${window.location.origin}/invite/${currentServer.inviteCode}`;
            document.getElementById('server-invite-modal').style.display = 'block';
        }

        function hideInviteModal() {
            document.getElementById('server-invite-modal').style.display = 'none';
        }

        function copyInviteLink() {
            const inviteLink = document.getElementById('invite-link');
            inviteLink.select();
            inviteLink.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(inviteLink.value).then(() => {
                const copyBtn = event.target;
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                copyBtn.style.background = '#43b581';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '';
                }, 2000);
            }).catch(() => {
                // Fallback for older browsers
                document.execCommand('copy');
                alert('Invite link copied to clipboard!');
            });
        }

        function showServerMenu() {
            // Only show server settings if user is the server owner and we're in a server
            if (currentServer && currentUser && currentServer.ownerId === currentUser.id) {
                showServerSettings();
            } else if (currentServer) {
                // Non-owners just see server info
                console.log('Server info for:', currentServer.name);
                showNotification('Only server owners can access server settings', 'info');
            } else {
                console.log('No current server');
            }
        }

        // Server Settings Modal Functions
        function showServerSettings() {
            console.log('showServerSettings called');
            console.log('currentServer:', currentServer);
            console.log('currentUser:', currentUser);
            
            if (!currentServer || currentServer.ownerId !== currentUser.id) {
                showNotification('Only server owners can access server settings', 'error');
                return;
            }

            // Populate server info
            document.getElementById('server-settings-title').textContent = `${currentServer.name} Settings`;
            document.getElementById('edit-server-name').value = currentServer.name || '';
            document.getElementById('edit-server-description').value = currentServer.description || '';
            
            // Switch to general tab and show modal
            switchServerSettingsTab('general');
            document.getElementById('server-settings-modal').style.display = 'block';
        }

        function hideServerSettings() {
            document.getElementById('server-settings-modal').style.display = 'none';
        }

        function switchServerSettingsTab(tab) {
            console.log('=== switchServerSettingsTab called with:', tab, '===');
            console.log('currentServer in tab switch:', currentServer);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tab + '-tab').classList.add('active');
            
            // Highlight the correct tab button
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach((btn, index) => {
                if ((tab === 'general' && index === 0) || 
                    (tab === 'members' && index === 1) || 
                    (tab === 'roles' && index === 2)) {
                    btn.classList.add('active');
                }
            });
            
            // Load tab-specific data
            if (tab === 'members') {
                console.log('Loading members for tab switch...');
                loadServerMembersForSettings();
            } else if (tab === 'roles') {
                loadServerRoles();
            }
        }

        async function updateServerSettings(event) {
            event.preventDefault();
            
            const name = document.getElementById('edit-server-name').value.trim();
            const description = document.getElementById('edit-server-description').value.trim();
            
            if (!name) {
                showNotification('Server name is required', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/servers/${currentServer.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ name, description })
                });

                if (response.ok) {
                    const updatedServer = await response.json();
                    currentServer.name = updatedServer.name;
                    currentServer.description = updatedServer.description;
                    
                    // Update UI
                    document.getElementById('current-server-name').textContent = updatedServer.name;
                    showNotification('Server settings updated successfully');
                } else {
                    const error = await response.json();
                    showNotification(error.message || 'Failed to update server settings', 'error');
                }
            } catch (error) {
                console.error('Update server error:', error);
                showNotification('Failed to update server settings', 'error');
            }
        }

        async function loadServerMembersForSettings() {
            console.log('=== loadServerMembersForSettings called ===');
            console.log('currentServer:', currentServer);
            console.log('currentUser:', currentUser);
            
            if (!currentServer) {
                console.error('No current server selected');
                return;
            }
            
            console.log('Current server:', currentServer);
            console.log('Current server ID:', currentServer.id);
            console.log('Current server ownerId:', currentServer.ownerId);
            
            const membersList = document.getElementById('server-members-list');
            membersList.innerHTML = '<div>Loading members...</div>';
            
            // Add temporary test data to verify the UI works
            /*
            membersList.innerHTML = `
                <div class="member-item">
                    <div class="member-info">
                        <div class="member-avatar" style="color: #43b581">T</div>
                        <div class="member-details">
                            <div class="member-username" style="color: #43b581">Test Owner</div>
                            <div class="member-role">Server Owner</div>
                        </div>
                    </div>
                    <div class="member-actions">
                        <span style="color: #43b581;">Server Owner</span>
                    </div>
                </div>
            `;
            return;
            */
            
            try {
                const url = `/api/servers/${currentServer.id}/members`;
                console.log('Fetching from URL:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Members data:', data);
                    
                    if (data.members && data.members.length > 0) {
                        // Add a nice header with member count
                        membersList.innerHTML = `
                            <div style="
                                padding: 16px;
                                border-bottom: 1px solid #4f545c;
                                margin-bottom: 12px;
                                background: rgba(114, 137, 218, 0.05);
                                border-radius: 4px;
                            ">
                                <h3 style="
                                    color: #dcddde;
                                    font-size: 16px;
                                    margin: 0 0 8px 0;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                ">
                                    ðŸ‘¥ Server Members
                                    <span style="
                                        background: #7289da;
                                        color: white;
                                        padding: 2px 8px;
                                        border-radius: 12px;
                                        font-size: 12px;
                                        font-weight: normal;
                                    ">${data.members.length}</span>
                                </h3>
                                <p style="color: #b9bbbe; font-size: 13px; margin: 0;">
                                    Manage server members and their roles
                                </p>
                            </div>
                        ` + data.members.map(member => `
                            <div class="member-item" style="display: flex; align-items: center; padding: 8px 16px; margin-bottom: 2px; border-radius: 3px; cursor: pointer; transition: background-color 0.2s;">
                                <div class="member-info" style="display: flex; align-items: center; flex: 1;">
                                    <div class="member-avatar" style="
                                        width: 32px; 
                                        height: 32px; 
                                        border-radius: 50%; 
                                        background: ${member.role === 'owner' ? 'linear-gradient(45deg, #43b581, #4caf50)' : '#7289da'}; 
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: center; 
                                        font-weight: bold; 
                                        font-size: 14px;
                                        color: white;
                                        margin-right: 12px;
                                    ">${member.username[0].toUpperCase()}</div>
                                    <div class="member-details">
                                        <div class="member-username" style="
                                            color: ${member.role === 'owner' ? '#43b581' : '#dcddde'}; 
                                            font-weight: 500; 
                                            font-size: 14px; 
                                            margin-bottom: 2px;
                                        ">${member.username}</div>
                                        <div class="member-role" style="
                                            color: #b9bbbe; 
                                            font-size: 12px; 
                                            display: flex; 
                                            align-items: center;
                                        ">
                                            ${member.role === 'owner' ? 'ðŸ‘‘' : 'ðŸ‘¤'} 
                                            ${member.role === 'owner' ? 'Server Owner' : member.role.charAt(0).toUpperCase() + member.role.slice(1)}
                                        </div>
                                    </div>
                                </div>
                                <div class="member-actions" style="margin-left: auto;">
                                    ${member.role === 'owner' ? 
                                        '<span style="color: #43b581; font-size: 12px; padding: 4px 8px; background: rgba(67, 181, 129, 0.1); border-radius: 12px; border: 1px solid rgba(67, 181, 129, 0.3);">Owner</span>' : 
                                        `<select style="
                                            background: #40444b; 
                                            color: #dcddde; 
                                            border: 1px solid #4f545c; 
                                            border-radius: 4px; 
                                            padding: 4px 8px; 
                                            font-size: 12px;
                                            cursor: pointer;
                                        " onchange="updateMemberRole(${member.userId}, this.value)">
                                            <option value="member" ${member.role === 'member' ? 'selected' : ''}>Member</option>
                                            <option value="admin" ${member.role === 'admin' ? 'selected' : ''}>Admin</option>
                                        </select>`
                                    }
                                </div>
                            </div>
                        `).join('');
                    } else {
                        membersList.innerHTML = '<div>No members found</div>';
                    }
                } else {
                    console.error('API error response status:', response.status);
                    const errorText = await response.text();
                    console.error('API error response body:', errorText);
                    membersList.innerHTML = '<div>Failed to load members</div>';
                }
            } catch (error) {
                console.error('Load members error:', error);
                membersList.innerHTML = '<div>Error loading members</div>';
            }
        }

        function loadServerRoles() {
            const rolesList = document.getElementById('roles-list');
            rolesList.innerHTML = `
                <div class="role-item">
                    <div>
                        <span class="role-name" style="color: #43b581;">@everyone</span>
                        <span style="color: #b9bbbe; font-size: 12px;">Default role for all members</span>
                    </div>
                    <div class="role-actions">
                        <button class="btn btn-sm btn-secondary" disabled>Default Role</button>
                    </div>
                </div>
            `;
        }

        function showCreateRoleForm() {
            document.getElementById('create-role-form').style.display = 'block';
        }

        function hideCreateRoleForm() {
            document.getElementById('create-role-form').style.display = 'none';
            document.getElementById('new-role-name').value = '';
            document.getElementById('new-role-color').value = '#5865f2';
            // Reset checkboxes
            document.querySelectorAll('.permissions-list input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        async function createRole(event) {
            event.preventDefault();
            
            const name = document.getElementById('new-role-name').value.trim();
            const color = document.getElementById('new-role-color').value;
            
            const permissions = [];
            if (document.getElementById('perm-manage-channels').checked) permissions.push('manage_channels');
            if (document.getElementById('perm-manage-members').checked) permissions.push('manage_members');
            if (document.getElementById('perm-kick-members').checked) permissions.push('kick_members');
            if (document.getElementById('perm-ban-members').checked) permissions.push('ban_members');
            if (document.getElementById('perm-create-invite').checked) permissions.push('create_invite');

            try {
                // TODO: Implement role creation API
                showNotification('Role creation coming soon!', 'info');
                hideCreateRoleForm();
            } catch (error) {
                console.error('Create role error:', error);
                showNotification('Failed to create role', 'error');
            }
        }

        // Update member role (for server owners/admins)
        async function updateMemberRole(userId, newRole) {
            if (!currentServer || currentServer.ownerId !== currentUser.id) {
                showNotification('Only server owners can change member roles', 'error');
                return;
            }

            try {
                // TODO: Implement member role update API
                showNotification('Member role management coming soon!', 'info');
            } catch (error) {
                console.error('Update member role error:', error);
                showNotification('Failed to update member role', 'error');
            }
        }

        // Fix tab switching to work with proper event target
        function switchServerSettingsTab(tab) {
            console.log('switchServerSettingsTab called with tab:', tab);
            console.log('currentServer in tab switch:', currentServer);
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tab + '-tab').classList.add('active');
            
            // Highlight the correct tab button
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach((btn, index) => {
                if ((tab === 'general' && index === 0) || 
                    (tab === 'members' && index === 1) || 
                    (tab === 'roles' && index === 2)) {
                    btn.classList.add('active');
                }
            });
            
            // Load tab-specific data
            if (tab === 'members') {
                console.log('Loading members for tab switch...');
                loadServerMembersForSettings();
            } else if (tab === 'roles') {
                loadServerRoles();
            }
        }

        // Role color display functions
        function getMemberRoleColor(userId, serverId) {
            // For now, return default colors based on role
            // In the future, this would look up the user's actual role and return its color
            if (currentServer && currentServer.ownerId === userId) {
                return '#43b581'; // Owner green
            }
            return '#dcddde'; // Default member color
        }

        function applyRoleColors() {
            // Apply role colors to member names in chat, members panel, etc.
            if (!currentServer) return;

            // Update member names in members panel
            document.querySelectorAll('.member-username').forEach(element => {
                const memberElement = element.closest('.member-item, .member');
                if (memberElement) {
                    const userId = memberElement.dataset.userId;
                    if (userId) {
                        const color = getMemberRoleColor(parseInt(userId), currentServer.id);
                        element.style.color = color;
                    }
                }
            });

            // Update message authors (this could be called when messages are displayed)
            document.querySelectorAll('.message-author').forEach(element => {
                const userId = element.dataset.userId;
                if (userId) {
                    const color = getMemberRoleColor(parseInt(userId), currentServer.id);
                    element.style.color = color;
                }
            });
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show notification to user
        function showNotification(message, type = 'success') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Style the notification
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
                transition: all 0.3s ease;
                background: ${type === 'error' ? 'linear-gradient(135deg, #ff6b6b, #ee5a52)' : 'linear-gradient(135deg, #51cf66, #40c057)'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) {
                return diffInSeconds <= 1 ? 'just now' : `${diffInSeconds}s ago`;
            }
            
            const diffInMinutes = Math.floor(diffInSeconds / 60);
            if (diffInMinutes < 60) {
                return `${diffInMinutes}m ago`;
            }
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) {
                return `${diffInHours}h ago`;
            }
            
            const diffInDays = Math.floor(diffInHours / 24);
            return `${diffInDays}d ago`;
        }

        function scrollToBottom() {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Main Friends UI Functions
        function showFriendsMain() {
            currentView = 'friends';
            currentChannel = null;
            currentServer = null;
            
            // Reset chat area state to prevent friends container from inheriting expanded width
            const chatArea = document.getElementById('chat-area');
            chatArea.classList.add('no-transition');
            chatArea.classList.remove('expanded');
            
            // Update UI visibility
            document.getElementById('messages-container').style.display = 'none';
            document.getElementById('friends-main-area').style.display = 'flex';
            document.getElementById('message-input-area').style.display = 'none';
            
            // Re-enable transitions after DOM update
            requestAnimationFrame(() => {
                chatArea.classList.remove('no-transition');
            });
            
            // Update sidebar selection
            document.querySelectorAll('.channel-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.dm-item').forEach(item => item.classList.remove('active')); // Unhighlight DM items
            document.querySelector('[onclick="showFriendsMain()"]').classList.add('active');
            
            // Update server list
            document.querySelectorAll('.server-icon').forEach(icon => icon.classList.remove('active'));
            document.querySelector('.server-icon.home').classList.add('active');
            
            // Update header
            document.getElementById('current-server-name').textContent = 'Friends';
            document.getElementById('header-icon').textContent = 'ðŸ‘¥';
            document.getElementById('current-channel-name').textContent = 'Friends';
            document.getElementById('current-channel-info').textContent = 'Manage your friends and connections';
            
            // Load current tab content
            switchFriendsTab('current');
        }
        
        function switchFriendsTab(tab) {
            console.log('Switching to friends tab:', tab);
            
            // Update nav buttons
            document.querySelectorAll('.friends-nav-btn-main').forEach(btn => btn.classList.remove('active'));
            const activeButton = document.querySelector(`[onclick="switchFriendsTab('${tab}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            } else {
                console.error('Could not find friends tab button for:', tab);
            }
            
            // Hide all tab contents
            document.querySelectorAll('.friends-tab-main').forEach(content => content.classList.remove('active'));
            
            // Show selected tab content
            let contentId;
            if (tab === 'pending') {
                contentId = 'pending-requests-content';
            } else {
                contentId = `${tab}-friends-content`;
            }
            
            const tabContent = document.getElementById(contentId);
            if (tabContent) {
                tabContent.classList.add('active');
            } else {
                console.error('Could not find friends tab content for:', tab, 'tried ID:', contentId);
            }
            
            // Load content based on tab
            if (tab === 'current') {
                loadCurrentFriends();
            } else if (tab === 'add') {
                setupUsernameSearch();
            } else if (tab === 'pending') {
                loadPendingRequestsMain();
            }
        }
        
        // Load current friends in grid format
        async function loadCurrentFriends() {
            try {
                const response = await fetch('/api/friends', {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                const data = await response.json();
                const friendsGrid = document.getElementById('current-friends-grid');
                
                if (data.friends && data.friends.length > 0) {
                    friendsGrid.innerHTML = data.friends.map(friend => `
                        <div class="friend-card">
                            <div class="friend-card-header">
                                <div class="friend-card-avatar">${friend.username.charAt(0).toUpperCase()}</div>
                                <div class="friend-card-info">
                                    <div class="friend-card-username">${friend.username}</div>
                                    <div class="friend-card-status">Online</div>
                                </div>
                            </div>
                            <div class="friend-card-actions">
                                <button class="friend-action-btn primary" onclick="startDMFromFriend('${friend.id}', '${friend.username}')">
                                    Message
                                </button>
                                <button class="friend-action-btn" onclick="viewFriendProfile('${friend.id}', '${friend.username}')">
                                    Profile
                                </button>
                                <button class="friend-action-btn danger" onclick="removeFriendCard('${friend.id}', '${friend.username}')">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    friendsGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-secondary);">
                            <h3>No friends yet</h3>
                            <p>Add some friends to get started!</p>
                            <button class="friend-action-btn primary" onclick="switchFriendsTab('add')">Add Friends</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }
        
        // Setup username search functionality
        function setupUsernameSearch() {
            const searchInput = document.getElementById('username-search-input');
            const resultsContainer = document.getElementById('username-search-results');
            
            // Clear previous results
            resultsContainer.innerHTML = '<div class="search-placeholder">Enter a username to find friends</div>';
            searchInput.value = '';
            
            // Set up real-time search
            searchInput.oninput = function() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => searchUsernameOnly(this.value), 300);
            };
            
            searchInput.focus();
        }
        
        // Search users by username only
        async function searchUsernameOnly(username) {
            const resultsContainer = document.getElementById('username-search-results');
            
            if (username.length < 2) {
                resultsContainer.innerHTML = '<div class="search-placeholder">Enter at least 2 characters</div>';
                return;
            }
            
            try {
                const response = await fetch(`/api/users/search?q=${encodeURIComponent(username)}`, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                const users = await response.json();
                
                if (users.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-placeholder">No users found</div>';
                    return;
                }
                
                resultsContainer.innerHTML = users.map(user => `
                    <div class="user-result-card" onclick="viewUserProfileDetailed('${user.id}', '${user.username}')">
                        <div class="user-result-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <div class="user-result-info">
                            <div class="user-result-username">${user.username}</div>
                            <div class="user-result-status">Click to view profile</div>
                        </div>
                        <div class="user-result-actions">
                            <button class="quick-add-btn" onclick="event.stopPropagation(); quickAddFriend('${user.id}', '${user.username}')" title="Add Friend">
                                +
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error searching users:', error);
                resultsContainer.innerHTML = '<div class="search-placeholder">Error searching users</div>';
            }
        }
        
        // Quick add friend function
        async function quickAddFriend(userId, username) {
            console.log('Quick add friend called:', userId, username);
            try {
                const response = await fetch('/api/friends/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ toUserId: userId })
                });
                
                console.log('Friend request response:', response.status);
                if (response.ok) {
                    const result = await response.json();
                    console.log('Friend request successful:', result);
                    showNotification(`Friend request sent to ${username}!`);
                    // Re-run search to update the UI
                    const searchInput = document.getElementById('username-search-input');
                    if (searchInput.value) {
                        searchUsernameOnly(searchInput.value);
                    }
                } else {
                    const error = await response.json();
                    console.error('Friend request failed:', error);
                    
                    // Handle specific error cases with better messages
                    if (error.error === 'Friend request already exists') {
                        showNotification(`Friend request to ${username} already pending!`, 'error');
                    } else if (error.error === 'User is already your friend') {
                        showNotification(`${username} is already your friend!`, 'error');
                    } else if (error.error === 'Cannot send friend request to yourself') {
                        showNotification(`You cannot add yourself as a friend!`, 'error');
                    } else {
                        showNotification(error.error || 'Failed to send friend request', 'error');
                    }
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
                showNotification('Error sending friend request', 'error');
            }
        }
        
        // Load pending requests in grid format
        async function loadPendingRequestsMain() {
            console.log('Loading pending requests...');
            try {
                const response = await fetch('/api/friends/requests/pending', {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                console.log('Pending requests response status:', response.status);
                if (!response.ok) {
                    console.error('Failed to load pending requests:', response.status, await response.text());
                    return;
                }
                
                const requests = await response.json();
                console.log('Received pending requests:', requests);
                const requestsGrid = document.getElementById('pending-requests-grid');
                
                if (!requestsGrid) {
                    console.error('Pending requests grid element not found!');
                    return;
                }
                
                if (requests.length > 0) {
                    console.log('Displaying requests:', requests.length);
                    requestsGrid.innerHTML = requests.map(request => `
                        <div class="friend-card">
                            <div class="friend-card-header">
                                <div class="friend-card-avatar">${request.username.charAt(0).toUpperCase()}</div>
                                <div class="friend-card-info">
                                    <div class="friend-card-username">${request.username}</div>
                                    <div class="friend-card-status">Wants to be friends</div>
                                </div>
                            </div>
                            <div class="friend-card-actions">
                                <button class="friend-action-btn primary" onclick="acceptFriendRequestMain('${request.id}')">
                                    Accept
                                </button>
                                <button class="friend-action-btn danger" onclick="declineFriendRequestMain('${request.id}')">
                                    Decline
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    requestsGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-secondary);">
                            <h3>No pending requests</h3>
                            <p>You don't have any friend requests right now.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading pending requests:', error);
            }
        }
        
        // Accept friend request from main UI
        async function acceptFriendRequestMain(requestId) {
            try {
                const response = await fetch(`/api/friends/request/${requestId}/accept`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok) {
                    showNotification('Friend request accepted!');
                    loadPendingRequestsMain();
                    if (document.getElementById('current-friends-content').classList.contains('active')) {
                        loadCurrentFriends();
                    }
                } else {
                    showNotification('Failed to accept friend request', 'error');
                }
            } catch (error) {
                console.error('Error accepting friend request:', error);
                showNotification('Error accepting friend request', 'error');
            }
        }
        
        // Decline friend request from main UI
        async function declineFriendRequestMain(requestId) {
            try {
                const response = await fetch(`/api/friends/request/${requestId}/decline`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok) {
                    showNotification('Friend request declined');
                    loadPendingRequestsMain();
                } else {
                    showNotification('Failed to decline friend request', 'error');
                }
            } catch (error) {
                console.error('Error declining friend request:', error);
                showNotification('Error declining friend request', 'error');
            }
        }
        
        // Detailed user profile view
        function viewUserProfileDetailed(userId, username) {
            currentProfileUser = { id: userId, username: username };
            document.getElementById('profile-username').textContent = username;
            document.getElementById('profile-avatar').textContent = username.charAt(0).toUpperCase();
            
            // Check if already friends or request exists
            checkFriendshipStatus(userId);
            
            document.getElementById('user-profile-modal').style.display = 'flex';
        }
        
        // Helper functions for friend cards
        function startDMFromFriend(userId, username) {
            console.log('Starting DM with friend:', userId, username);
            
            // Check if DM already exists, if so just open it
            if (dmUsers.has(parseInt(userId))) {
                console.log('DM already exists, opening existing conversation');
                openDirectMessage(userId, username);
                return;
            }
            
            // Add to DM list first
            addToDMList({ id: parseInt(userId), username: username });
            
            // Then open the conversation
            openDirectMessage(userId, username);
        }
        
        function viewFriendProfile(userId, username) {
            viewUserProfileDetailed(userId, username);
        }
        
        function removeFriendCard(userId, username) {
            if (!confirm(`Remove ${username} from your friends?`)) return;
            
            removeFriendById(userId).then(() => {
                loadCurrentFriends(); // Refresh the friends grid
            });
        }
        
        // Remove friend by ID
        async function removeFriendById(userId) {
            try {
                const response = await fetch(`/api/friends/${userId}`, {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok) {
                    showNotification('Friend removed');
                    return true;
                } else {
                    showNotification('Failed to remove friend', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error removing friend:', error);
                showNotification('Error removing friend', 'error');
                return false;
            }
        }
        
        // Update the main initialization to use new friends function
        function selectFriendsButton() {
            showFriendsMain();
        }
        
        async function searchUsers() {
            const searchTerm = document.getElementById('user-search-input').value.trim();
            const resultsContainer = document.getElementById('search-results');
            
            if (searchTerm.length < 2) {
                resultsContainer.innerHTML = '<div class="search-message">Enter at least 2 characters to search</div>';
                return;
            }
            
            try {
                const response = await fetch(`/api/users/search?q=${encodeURIComponent(searchTerm)}`, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                const users = await response.json();
                
                if (users.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-message">No users found</div>';
                    return;
                }
                
                resultsContainer.innerHTML = users.map(user => `
                    <div class="user-search-result" onclick="openUserProfile('${user.id}', '${user.username}')">
                        <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <div class="user-info">
                            <div class="user-name">${user.username}</div>
                            <div class="user-status">Click to view profile</div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error searching users:', error);
                resultsContainer.innerHTML = '<div class="search-message">Error searching users</div>';
            }
        }
        
        // Open user profile modal
        function openUserProfile(userId, username) {
            currentProfileUser = { id: userId, username: username };
            document.getElementById('profile-username').textContent = username;
            document.getElementById('profile-avatar').textContent = username.charAt(0).toUpperCase();
            
            // Check if already friends or request exists
            checkFriendshipStatus(userId);
            
            document.getElementById('user-profile-modal').style.display = 'flex';
        }
        
        // Check friendship status and update profile buttons
        async function checkFriendshipStatus(userId) {
            try {
                const response = await fetch('/api/friends/status/' + userId, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                const status = await response.json();
                const actionsDiv = document.querySelector('.profile-actions');
                
                if (status.areFriends) {
                    actionsDiv.innerHTML = `
                        <button class="profile-btn remove-friend" onclick="removeFriendFromProfile()">
                            Remove Friend
                        </button>
                        <button class="profile-btn send-message" onclick="startDirectMessage()">
                            Send Message
                        </button>
                    `;
                } else if (status.pendingRequest) {
                    actionsDiv.innerHTML = `
                        <button class="profile-btn pending" disabled>
                            Friend Request Pending
                        </button>
                    `;
                } else {
                    actionsDiv.innerHTML = `
                        <button class="profile-btn add-friend" onclick="sendFriendRequestFromProfile()">
                            Add Friend
                        </button>
                    `;
                }
                
            } catch (error) {
                console.error('Error checking friendship status:', error);
            }
        }
        
        // Send friend request from profile
        async function sendFriendRequestFromProfile() {
            if (!currentProfileUser) return;
            
            try {
                const response = await fetch('/api/friends/request', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ toUserId: currentProfileUser.id })
                });
                
                if (response.ok) {
                    showNotification('Friend request sent!');
                    checkFriendshipStatus(currentProfileUser.id);
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to send friend request', 'error');
                }
            } catch (error) {
                console.error('Error sending friend request:', error);
                showNotification('Error sending friend request', 'error');
            }
        }
        
        // Remove friend from profile
        async function removeFriendFromProfile() {
            if (!currentProfileUser) return;
            
            if (!confirm(`Remove ${currentProfileUser.username} from your friends?`)) return;
            
            try {
                const response = await fetch(`/api/friends/${currentProfileUser.id}`, {
                    method: 'DELETE',
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok) {
                    showNotification('Friend removed');
                    checkFriendshipStatus(currentProfileUser.id);
                    loadFriends(); // Refresh friends list
                } else {
                    showNotification('Failed to remove friend', 'error');
                }
            } catch (error) {
                console.error('Error removing friend:', error);
                showNotification('Error removing friend', 'error');
            }
        }
        
        // Start direct message
        function startDirectMessage() {
            if (!currentProfileUser) return;
            
            // Switch to DM view
            currentView = 'dm';
            currentChannel = null;
            currentServer = null;
            
            // Update UI
            document.getElementById('friends-section').style.display = 'block';
            document.getElementById('server-channels-section').style.display = 'none';
            document.getElementById('message-input-area').style.display = 'block';
            document.querySelector('.server-icon.active')?.classList.remove('active');
            document.getElementById('friends-btn').classList.add('active');
            document.getElementById('current-server-name').textContent = `Direct Message with ${currentProfileUser.username}`;
            
            // Close profile modal
            closeUserProfile();
            
            // Load DM messages
            loadDirectMessages(currentProfileUser.id);
            
            // Add to DM list if not already there
            addToDMList(currentProfileUser);
        }
        
        // Close user profile modal
        function closeUserProfile() {
            document.getElementById('user-profile-modal').style.display = 'none';
            currentProfileUser = null;
        }
        
        // Show friends tab content
        function showFriendsTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.friends-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="showFriendsTab('${tab}')"]`).classList.add('active');
            
            // Hide all tab contents
            document.querySelectorAll('.friends-tab-content').forEach(content => content.style.display = 'none');
            
            // Show selected tab content
            document.getElementById(`${tab}-friends-tab`).style.display = 'block';
            
            // Load content based on tab
            if (tab === 'all') {
                loadFriends();
            } else if (tab === 'pending') {
                loadPendingRequests();
            }
        }
        
        // Load pending friend requests
        async function loadPendingRequests() {
            try {
                const response = await fetch('/api/friends/requests/pending', {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                const requests = await response.json();
                const container = document.getElementById('pending-requests-list');
                
                if (requests.length === 0) {
                    container.innerHTML = '<div class="no-friends">No pending friend requests</div>';
                    return;
                }
                
                container.innerHTML = requests.map(request => `
                    <div class="friend-item">
                        <div class="friend-avatar">${request.username.charAt(0).toUpperCase()}</div>
                        <div class="friend-info">
                            <div class="friend-name">${request.username}</div>
                            <div class="friend-status">Wants to be friends</div>
                        </div>
                        <div class="friend-actions">
                            <button class="friend-action-btn accept" onclick="acceptFriendRequest('${request.id}')">Accept</button>
                            <button class="friend-action-btn decline" onclick="declineFriendRequest('${request.id}')">Decline</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading pending requests:', error);
            }
        }
        
        // Accept friend request
        async function acceptFriendRequest(requestId) {
            try {
                const response = await fetch(`/api/friends/request/${requestId}/accept`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok) {
                    showNotification('Friend request accepted!');
                    loadPendingRequests();
                    loadFriends();
                } else {
                    showNotification('Failed to accept friend request', 'error');
                }
            } catch (error) {
                console.error('Error accepting friend request:', error);
                showNotification('Error accepting friend request', 'error');
            }
        }
        
        // Decline friend request
        async function declineFriendRequest(requestId) {
            try {
                const response = await fetch(`/api/friends/request/${requestId}/decline`, {
                    method: 'POST',
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok) {
                    showNotification('Friend request declined');
                    loadPendingRequests();
                } else {
                    showNotification('Failed to decline friend request', 'error');
                }
            } catch (error) {
                console.error('Error declining friend request:', error);
                showNotification('Error declining friend request', 'error');
            }
        }

        // Direct Messages functionality
        let directMessages = new Map(); // userId -> messages array
        let dmUsers = new Map(); // userId -> user info

        // Load direct messages with a user
        async function loadDirectMessages(userId) {
            console.log('Loading direct messages with user:', userId);
            try {
                const response = await fetch(`/api/messages/dm/${userId}`, {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                console.log('DM response status:', response.status);
                if (response.ok) {
                    const messages = await response.json();
                    console.log('Received DM messages:', messages);
                    directMessages.set(parseInt(userId), messages);
                    displayMessages(messages);
                    updateDMList(); // Refresh DM list with latest message preview
                } else {
                    console.log('No DM messages found, starting fresh conversation');
                    directMessages.set(parseInt(userId), []);
                    displayMessages([]);
                }
            } catch (error) {
                console.error('Error loading direct messages:', error);
                directMessages.set(parseInt(userId), []);
                displayMessages([]);
            }
        }
        
        // Add user to DM list
        function addToDMList(user) {
            console.log('Adding user to DM list:', user);
            // Check if user already exists to prevent duplicates
            if (dmUsers.has(user.id)) {
                console.log('User already in DM list, skipping duplicate');
                return;
            }
            dmUsers.set(user.id, user);
            updateDMList();
            console.log('DM users list:', Array.from(dmUsers.values()));
        }
        
        // Ensure correct sidebar highlighting
        function ensureCorrectHighlighting() {
            if (currentView === 'dm' && currentDMUser) {
                const targetDMItem = document.querySelector(`[data-user-id="${currentDMUser.id}"]`);
                
                // Only update if highlighting is incorrect
                if (targetDMItem && !targetDMItem.classList.contains('active')) {
                    // Remove all active states
                    document.querySelectorAll('.channel-item').forEach(item => item.classList.remove('active'));
                    document.querySelectorAll('.dm-item').forEach(item => item.classList.remove('active'));
                    
                    // Highlight the current DM conversation
                    targetDMItem.classList.add('active');
                }
            } else if (currentView === 'friends') {
                const friendsBtn = document.querySelector('[data-view="friends"]');
                
                // Only update if highlighting is incorrect
                if (friendsBtn && !friendsBtn.classList.contains('active')) {
                    document.querySelectorAll('.channel-item').forEach(item => item.classList.remove('active'));
                    document.querySelectorAll('.dm-item').forEach(item => item.classList.remove('active'));
                    friendsBtn.classList.add('active');
                }
            }
        }
        
        // Get last message preview for DM list
        function getLastMessagePreview(userId) {
            const userMessages = directMessages.get(parseInt(userId));
            if (!userMessages || userMessages.length === 0) {
                return 'Click to start conversation';
            }
            
            const lastMessage = userMessages[userMessages.length - 1];
            const preview = lastMessage.text || 'Image';
            return preview.length > 30 ? preview.substring(0, 30) + '...' : preview;
        }
        
        // Update DM list display
        function updateDMList() {
            const dmList = document.getElementById('dm-conversations');
            
            // Safety check - element might not exist
            if (!dmList) {
                console.log('DM list element not found - skipping update');
                return;
            }
            
            if (dmUsers.size === 0) {
                dmList.innerHTML = '<div class="no-dms">No direct messages yet</div>';
                return;
            }
            
            // Check if we need to regenerate the entire list or just update previews
            const existingItems = dmList.querySelectorAll('.dm-item');
            const currentUserIds = Array.from(dmUsers.keys());
            const existingUserIds = Array.from(existingItems).map(item => parseInt(item.dataset.userId));
            
            // If user list changed, regenerate entire list
            if (currentUserIds.length !== existingUserIds.length || 
                !currentUserIds.every(id => existingUserIds.includes(id))) {
                
                dmList.innerHTML = Array.from(dmUsers.values()).map(user => `
                    <div class="dm-item" onclick="openDirectMessage('${user.id}', '${user.username}')" data-user-id="${user.id}">
                        <div class="dm-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <div class="dm-info">
                            <div class="dm-username">${user.username}</div>
                            <div class="dm-last-message">${getLastMessagePreview(user.id)}</div>
                        </div>
                    </div>
                `).join('');
                
                // Restore highlighting after regeneration
                setTimeout(() => ensureCorrectHighlighting(), 10);
            } else {
                // Just update message previews without regenerating HTML
                existingItems.forEach(item => {
                    const userId = parseInt(item.dataset.userId);
                    const messageElement = item.querySelector('.dm-last-message');
                    if (messageElement) {
                        messageElement.textContent = getLastMessagePreview(userId);
                    }
                });
            }
        }
        
        // Open direct message conversation
        function openDirectMessage(userId, username) {
            console.log('Opening DM with:', userId, username);
            currentView = 'dm';
            currentChannel = null;
            currentServer = null;
            currentDMUser = { id: parseInt(userId), username: username };
            
            // Reset chat area state to prevent DM area from inheriting expanded width
            const chatArea = document.getElementById('chat-area');
            chatArea.classList.add('no-transition');
            chatArea.classList.remove('expanded');
            
            // Update UI
            document.getElementById('friends-section').style.display = 'block';
            document.getElementById('server-channels-section').style.display = 'none';
            document.getElementById('message-input-area').style.display = 'block';
            document.querySelector('.server-icon.active')?.classList.remove('active');
            
            // Re-enable transitions after DOM update
            requestAnimationFrame(() => {
                chatArea.classList.remove('no-transition');
            });
            
            // Activate friends section in sidebar, but not the Friends button itself when in DM
            document.querySelectorAll('.channel-item').forEach(item => item.classList.remove('active'));
            // Don't highlight the Friends button when in a specific DM conversation
            
            // Highlight current DM conversation immediately
            document.querySelectorAll('.dm-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-user-id="${userId}"]`)?.classList.add('active');
            
            // Update header to show DM conversation
            document.getElementById('current-server-name').textContent = `Direct Message with ${username}`;
            document.getElementById('header-icon').textContent = 'ðŸ’¬';
            document.getElementById('current-channel-name').textContent = username;
            document.getElementById('current-channel-info').textContent = 'Direct Message';
            
            // Hide friends main area and show chat area
            document.getElementById('friends-main-area').style.display = 'none';
            document.getElementById('chat-area').style.display = 'flex';
            document.getElementById('messages-container').style.display = 'block';
            
            // Clear messages and load DM messages
            document.getElementById('messages-container').innerHTML = '';
            loadDirectMessages(userId);
            
            // Ensure DM highlighting persists after async operations
            setTimeout(() => {
                ensureCorrectHighlighting();
            }, 10);
        }

        // Load DM conversations list
        async function loadDMConversations() {
            try {
                const response = await fetch('/api/messages/conversations', {
                    headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
                });
                
                if (response.ok) {
                    const conversations = await response.json();
                    conversations.forEach(conv => {
                        dmUsers.set(conv.id, { 
                            id: conv.id, 
                            username: conv.username 
                        });
                    });
                    updateDMList();
                }
            } catch (error) {
                console.error('Error loading DM conversations:', error);
            }
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const serverModal = document.getElementById('server-modal');
            const addFriendModal = document.getElementById('add-friend-modal');
            const inviteModal = document.getElementById('server-invite-modal');
            const imageModal = document.getElementById('image-modal');
            const profileModal = document.getElementById('user-profile-modal');
            
            if (event.target === serverModal) {
                hideServerModal();
            }
            if (event.target === addFriendModal) {
                hideAddFriendModal();
            }
            if (event.target === inviteModal) {
                hideInviteModal();
            }
            if (event.target === imageModal) {
                closeImageModal();
            }
            if (event.target === profileModal) {
                closeUserProfile();
            }
        }

        // Channel Management Functions
        function showCreateChannelModal() {
            if (!currentServer) return;
            document.getElementById('create-channel-modal').style.display = 'block';
        }

        function hideCreateChannelModal() {
            document.getElementById('create-channel-modal').style.display = 'none';
            document.getElementById('channel-name').value = '';
            document.getElementById('channel-description').value = '';
        }

        async function createChannel(event) {
            event.preventDefault();
            
            const name = document.getElementById('channel-name').value.trim();
            const description = document.getElementById('channel-description').value.trim();
            
            if (!name || !currentServer) return;
            
            try {
                const response = await fetch(`/api/servers/${currentServer.id}/channels`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        name: name.toLowerCase().replace(/[^a-z0-9-]/g, ''),
                        description
                    })
                });

                if (response.ok) {
                    hideCreateChannelModal();
                    await loadServerChannels(currentServer.id);
                    showNotification('Channel created successfully!', 'success');
                } else {
                    const error = await response.json();
                    alert(error.message || 'Failed to create channel');
                }
            } catch (error) {
                console.error('Error creating channel:', error);
                alert('Failed to create channel. Please try again.');
            }
        }

        // Members Panel Functions
        // Members panel state
        let membersPanelCollapsed = false;

        function showMembersPanel() {
            const panel = document.getElementById('members-panel');
            const toggleBtn = document.getElementById('members-toggle');
            const chatArea = document.getElementById('chat-area');
            
            // Temporarily disable transitions to prevent stretching animation
            chatArea.classList.add('no-transition');
            
            // Pre-set the state based on server preferences BEFORE showing elements
            let shouldBeCollapsed = false;
            if (currentServer && currentServer.id) {
                const serverPrefs = getServerPreferences(currentServer.id);
                shouldBeCollapsed = serverPrefs.membersPanelCollapsed;
                membersPanelCollapsed = shouldBeCollapsed;
            } else {
                membersPanelCollapsed = false;
            }
            
            // Set all classes immediately before showing to prevent visual stretching
            if (shouldBeCollapsed) {
                panel.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                chatArea.classList.add('expanded');
            } else {
                panel.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                chatArea.classList.remove('expanded');
            }
            
            // Show the elements after state is set
            panel.style.display = 'flex';
            toggleBtn.style.display = 'flex';
            
            // Re-enable transitions after the DOM has updated
            requestAnimationFrame(() => {
                chatArea.classList.remove('no-transition');
            });
            
            console.log(`Showed members panel for server ${currentServer?.id || 'unknown'} with collapsed state:`, shouldBeCollapsed);
        }

        function hideMembersPanel() {
            const panel = document.getElementById('members-panel');
            const toggleBtn = document.getElementById('members-toggle');
            const chatArea = document.getElementById('chat-area');
            
            panel.style.display = 'none';
            toggleBtn.style.display = 'none';
            
            // Reset state and clean up classes
            membersPanelCollapsed = false;
            panel.classList.remove('collapsed');
            toggleBtn.classList.remove('collapsed');
            chatArea.classList.remove('expanded', 'no-transition');
        }

        function toggleMembersPanel() {
            const panel = document.getElementById('members-panel');
            const toggleBtn = document.getElementById('members-toggle');
            const chatArea = document.getElementById('chat-area');
            
            membersPanelCollapsed = !membersPanelCollapsed;
            
            if (membersPanelCollapsed) {
                // Hide panel and expand chat area
                panel.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                chatArea.classList.add('expanded');
            } else {
                // Show panel and restore chat area
                panel.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                chatArea.classList.remove('expanded');
            }
            
            // Save the panel state for current server
            saveMembersPanelState();
        }

        // Helper functions for server-specific preferences
        function saveMembersPanelState() {
            if (currentServer && currentServer.id) {
                const serverPrefs = getServerPreferences(currentServer.id);
                serverPrefs.membersPanelCollapsed = membersPanelCollapsed;
                saveServerPreferences(currentServer.id, serverPrefs);
                console.log(`Saved members panel state for server ${currentServer.id}:`, membersPanelCollapsed);
            }
        }

        function getServerPreferences(serverId) {
            const saved = localStorage.getItem(`server_prefs_${serverId}`);
            return saved ? JSON.parse(saved) : { membersPanelCollapsed: false };
        }

        function saveServerPreferences(serverId, preferences) {
            localStorage.setItem(`server_prefs_${serverId}`, JSON.stringify(preferences));
        }

        function restoreMembersPanelState(serverId) {
            const serverPrefs = getServerPreferences(serverId);
            membersPanelCollapsed = serverPrefs.membersPanelCollapsed;
            console.log(`Restored members panel state for server ${serverId}:`, membersPanelCollapsed);
            
            const panel = document.getElementById('members-panel');
            const toggleBtn = document.getElementById('members-toggle');
            const chatArea = document.getElementById('chat-area');
            
            if (membersPanelCollapsed) {
                panel.classList.add('collapsed');
                toggleBtn.classList.add('collapsed');
                chatArea.classList.add('expanded');
            } else {
                panel.classList.remove('collapsed');
                toggleBtn.classList.remove('collapsed');
                chatArea.classList.remove('expanded');
            }
        }

        async function loadServerMembers(serverId) {
            try {
                const response = await fetch(`/api/servers/${serverId}/members`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayServerMembers(data.members);
                } else {
                    console.error('Failed to load server members');
                }
            } catch (error) {
                console.error('Error loading server members:', error);
            }
        }

        function displayServerMembers(members) {
            const membersList = document.getElementById('members-list');
            const membersCount = document.getElementById('members-count');
            
            membersList.innerHTML = '';
            membersCount.textContent = members.length;

            // Group members by role
            const owners = members.filter(m => m.role === 'owner');
            const admins = members.filter(m => m.role === 'admin');
            const regularMembers = members.filter(m => m.role === 'member');

            // Display owners
            if (owners.length > 0) {
                membersList.innerHTML += '<div style="padding: 8px 16px; color: #8e9297; font-size: 12px; font-weight: bold; text-transform: uppercase;">Owner</div>';
                owners.forEach(member => {
                    membersList.innerHTML += createMemberHTML(member);
                });
            }

            // Display admins
            if (admins.length > 0) {
                membersList.innerHTML += '<div style="padding: 8px 16px; color: #8e9297; font-size: 12px; font-weight: bold; text-transform: uppercase;">Admins</div>';
                admins.forEach(member => {
                    membersList.innerHTML += createMemberHTML(member);
                });
            }

            // Display members
            if (regularMembers.length > 0) {
                membersList.innerHTML += '<div style="padding: 8px 16px; color: #8e9297; font-size: 12px; font-weight: bold; text-transform: uppercase;">Members</div>';
                regularMembers.forEach(member => {
                    membersList.innerHTML += createMemberHTML(member);
                });
            }
        }

        function createMemberHTML(member) {
            return `
                <div class="member-item" onclick="showUserProfile(${member.userId})">
                    <div class="member-avatar">${member.username.charAt(0).toUpperCase()}</div>
                    <div class="member-info">
                        <div class="member-name">${member.username}</div>
                        <div class="member-role">${member.role}</div>
                    </div>
                </div>
            `;
        }

        async function checkChannelManagementPermission(serverId) {
            try {
                const response = await fetch(`/api/servers/${serverId}/members`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const currentUserMember = data.members.find(m => m.userId === currentUser.id);
                    
                    // Show channel management button only for owners and admins
                    const addChannelBtn = document.getElementById('add-channel-btn');
                    if (currentUserMember && (currentUserMember.role === 'owner' || currentUserMember.role === 'admin')) {
                        addChannelBtn.style.display = 'flex';
                    } else {
                        addChannelBtn.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error checking channel management permission:', error);
                // Hide button on error
                document.getElementById('add-channel-btn').style.display = 'none';
            }
        }
    </script>
</body>
</html>